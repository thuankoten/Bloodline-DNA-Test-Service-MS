<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quản lý hồ sơ khách hàng - Dịch vụ xét nghiệm DNA Bloodline</title>
    <link rel="stylesheet" href="../css/style.css" />
    <link rel="stylesheet" href="../css/dashboard.css" />
    <link rel="stylesheet" href="../css/customer-profile.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
  </head>
  <body class="dashboard-page">
    <header class="dashboard-header">
      <div class="container">
        <div class="logo">
          <a href="index.html">
            <i class="fas fa-dna"></i> <span>Bloodline</span>
          </a>
        </div>

        <div class="header-right">
          <div class="search-bar">
            <input type="text" placeholder="Tìm kiếm..." />
            <button><i class="fas fa-search"></i></button>
          </div>

          <div class="notification">
            <i class="fas fa-bell"></i>
            <span class="badge">3</span>
          </div>

          <div class="user-menu">
            <img
              src="img/user-avatar.jpg"
              alt="Ảnh đại diện người dùng"
              class="avatar"
            />
            <div class="user-info">
              <span class="user-name"></span>
              <span class="user-role">Quản lý</span>
            </div>
            <i class="fas fa-chevron-down"></i>
          </div>
        </div>
      </div>
    </header>

    <div class="dashboard-wrapper">
      <aside class="sidebar">
        <nav class="main-nav">
          <ul>
            <li class="">
              <a href="manager-dashboard.html">
                <i class="fas fa-tachometer-alt"></i>
                <span>Bảng điều khiển</span>
              </a>
            </li>
            <li>
              <a href="customer-tests.html">
                <i class="fas fa-vial"></i>
                <span>Quản lý đơn đặt xét nghiệm</span>
              </a>
            </li>
            <li>
              <a href="results-manager.html">
                <i class="fas fa-file-medical-alt"></i>
                <span>Quản lý kết quả xét nghiệm</span>
              </a>
            </li>
            <li class="active">
            <a href="customer-profile.html">
                <i class="fa-solid fa-hospital-user"></i>
                <span>Quản lý hồ sơ khách hàng</span>
              </a>
            </li>
            <li>
              <a href="support.html">
                <i class="fas fa-comments"></i>
                <span>Hỗ trợ khách hàng</span>
              </a>
            </li>
            <li>
              <a href="appointments-manager.html">
                <i class="fas fa-calendar-alt"></i>
                <span>Quản lý lịch hẹn</span>
              </a>
            </li>
            <li>
              <a href="staff-manager.html">
                <i class="fas fa-user-circle"></i>
                <span>Quản lý nhân viên</span>
              </a>
            </li>
            <li>
            <a href="family-tree.html">
                <i class="fa-solid fa-receipt"></i>
                <span>Thống kê và báo cáo</span>
              </a>
            </li>
            <li>
              <a href="settings.html">
                <i class="fas fa-cog"></i>
                <span>Cài đặt</span>
              </a>
            </li>
            <li class="logout">
              <a href="#" id="logout-link">
                <i class="fas fa-sign-out-alt"></i>
                <span>Đăng xuất</span>
              </a>
            </li>
          </ul>
        </nav>
      </aside>

       <main class="dashboard-main">
        <div class="page-header">
          <h1>Quản lý hồ sơ khách hàng</h1>
        </div>
        <div class="customer-table-container">
          <!-- Nút mở form -->
          <button id="showAddCustomerFormBtn">Thêm khách hàng</button>

          <!-- Form thêm khách hàng (ẩn mặc định) -->
          <div id="addCustomerForm" style="margin-bottom: 20px; display: none;">
            <input type="text" id="email" placeholder="Email" required>
            <input type="text" id="firstName" placeholder="Họ" required>
            <input type="text" id="lastName" placeholder="Tên" required>
            <input type="password" id="password" placeholder="Password" required>
            <input type="text" id="phone" placeholder="Số điện thoại">
            <input type="text" id="username" placeholder="Username">
            <select id="active">
              <option value="true">Active</option>
              <option value="false">Inactive</option>
            </select>
            <input type="text" id="role" placeholder="Role">
            <button onclick="addCustomer()">Thêm khách hàng</button>
            <button type="button" id="cancelAddCustomerBtn">Hủy</button>
          </div>
          <!-- Ô tìm kiếm khách hàng -->
          <input type="text" id="customerSearchInput" placeholder="Tìm kiếm khách hàng..." style="margin-bottom: 16px; width: 300px;">
          <table class="customer-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Email</th>
                <th>Họ</th>
                <th>Tên</th>
                <th>Password</th>
                <th>Số điện thoại</th>
                <th>Username</th>
                <th>Active</th>
                <th>Role</th>
                <th>Hành động</th>
              </tr>
            </thead>
            <tbody>
              <!-- Dữ liệu sẽ được render ở đây -->
            </tbody>
          </table>
        </div>
      </main>
    </div>

    <footer class="dashboard-footer">
      <div class="container">
        <p>&copy; 2023 Dịch vụ xét nghiệm DNA Bloodline. Bảo lưu mọi quyền.</p>
        <ul class="footer-links">
          <li><a href="privacy.html">Chính sách bảo mật</a></li>
          <li><a href="terms.html">Điều khoản dịch vụ</a></li>
          <li><a href="contact.html">Liên hệ chúng tôi</a></li>
        </ul>
      </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="js/dashboard.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const username = sessionStorage.getItem("loggedInUsername"); // Lấy username từ sessionStorage

        if (username) {
          // Cập nhật username trong header
          const userNameElements = document.querySelectorAll(".user-name");
          userNameElements.forEach((element) => {
            element.textContent = username;
          });

          // Cập nhật username trong phần "Chào mừng trở lại"
          const welcomeUserNameElement =
            document.getElementById("welcome-user-name");
          if (welcomeUserNameElement) {
            welcomeUserNameElement.textContent = username;
          }
        } else {
          console.warn(
            "Không tìm thấy username trong sessionStorage. Người dùng có thể chưa đăng nhập hoặc phiên đã hết hạn."
          );
          // Tùy chọn: Chuyển hướng người dùng về trang đăng nhập nếu không tìm thấy username
          // Đây là một biện pháp bảo mật tốt để ngăn người dùng truy cập dashboard khi chưa đăng nhập.
          // window.location.href = 'login.html';
        }

        // Xử lý sự kiện đăng xuất
        const logoutLink = document.getElementById("logout-link");
        if (logoutLink) {
          logoutLink.addEventListener("click", function (e) {
            e.preventDefault(); // Ngăn chặn hành vi mặc định của thẻ <a>

            // Xóa username khỏi sessionStorage
            sessionStorage.removeItem("loggedInUsername");
            console.log("Username đã bị xóa khỏi sessionStorage.");

            // Chuyển hướng về trang chủ hoặc trang đăng nhập
            window.location.href = "index.html"; // Hoặc 'login.html' tùy ý
          });
        }

        // Notification filter
        const filterBtns = document.querySelectorAll('.filter-btn');
        const notifItems = document.querySelectorAll('.notif-item');
        filterBtns.forEach(btn => {
          btn.addEventListener('click', function() {
            filterBtns.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            const type = this.getAttribute('data-type');
            notifItems.forEach(item => {
              if (type === 'all' || item.classList.contains(type)) {
                item.style.display = '';
              } else {
                item.style.display = 'none';
              }
            });
          });
        });

        let allCustomers = [];

        function renderCustomerTable(customers) {
          const tbody = document.querySelector('.customer-table tbody');
          tbody.innerHTML = '';
          customers.filter(customer => customer.role === 'customer').forEach(customer => {
            tbody.innerHTML += `
              <tr>
                <td>${customer.id}</td>
                <td>${customer.email}</td>
                <td>${customer.firstName}</td>
                <td>${customer.lastName}</td>
                <td>*******</td>
                <td>${customer.phone}</td>
                <td>${customer.username}</td>
                <td>${customer.active ? 'true' : 'false'}</td>
                <td>${customer.role}</td>
                <td>
                  <button class="edit-btn" onclick='editCustomer(${JSON.stringify(customer).replace(/'/g, "\\'")})'>Sửa</button>
                  <button class="delete-btn" onclick="deleteCustomer(${customer.id})">Xóa</button>
                </td>
              </tr>
            `;
          });
        }

        // Khi tải trang, lấy dữ liệu và render bảng
        fetch('/api/customers')
          .then(response => response.json())
          .then(data => {
            allCustomers = data;
            renderCustomerTable(allCustomers);
          });

          // Xử lý tìm kiếm
          document.getElementById('customerSearchInput').addEventListener('input', function() {
            const keyword = this.value.trim().toLowerCase();
            const filtered = allCustomers.filter(customer => {
              return (
                (customer.firstName && customer.firstName.toLowerCase().includes(keyword)) ||
                (customer.lastName && customer.lastName.toLowerCase().includes(keyword)) ||
                (customer.username && customer.username.toLowerCase().includes(keyword)) ||
                (customer.email && customer.email.toLowerCase().includes(keyword)) ||
                (customer.phone && customer.phone.includes(keyword))
              );
            });
            renderCustomerTable(filtered);
          });

          // Ẩn/hiện form thêm khách hàng
          const showBtn = document.getElementById('showAddCustomerFormBtn');
          const form = document.getElementById('addCustomerForm');
          const cancelBtn = document.getElementById('cancelAddCustomerBtn');

          showBtn.addEventListener('click', function() {
            form.style.display = 'block';
            showBtn.style.display = 'none';
          });

          cancelBtn.addEventListener('click', function() {
            form.style.display = 'none';
            showBtn.style.display = 'inline-block';
            form.querySelectorAll('input').forEach(input => input.value = '');
            form.querySelector('select').selectedIndex = 0;
            form.removeAttribute('data-edit-id');
          });
      });

      // Thêm khách hàng mới (ví dụ)
      function addCustomer() {
        const form = document.getElementById('addCustomerForm');
        const editId = form.getAttribute('data-edit-id');
        const email = document.getElementById('email').value.trim();
        const firstName = document.getElementById('firstName').value.trim();
        const lastName = document.getElementById('lastName').value.trim();
        const password = document.getElementById('password').value;
        const phone = document.getElementById('phone').value.trim();
        const username = document.getElementById('username').value.trim();
        const active = document.getElementById('active').value === "true";
        let role = document.getElementById('role').value.trim();

        // Validation
        if (!email.includes('@gmail.com')) {
          alert('Email phải chứa ký tự @');
          return;
        }
        if (password.length < 8) {
          alert('Password phải có ít nhất 8 ký tự');
          return;
        }
        if (!/^\d{10}$/.test(phone)) {
          alert('Số điện thoại phải là 10 chữ số');
          return;
        }
        // Role mặc định là customer nếu để trống hoặc khác customer
        if (!role || role.toLowerCase() !== 'customer') {
          role = 'customer';
          document.getElementById('role').value = 'customer';
        }

        const customer = {
          email,
          firstName,
          lastName,
          password,
          phone,
          username,
          active,
          role
        };

        let url = '/api/customers';
        let method = 'POST';

        if (editId) {
          url += `/${editId}`;
          method = 'PUT';
        }

        fetch(url, {
          method: method,
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(customer)
        })
        .then(response => response.json())
        .then(data => {
          alert(editId ? 'Cập nhật khách hàng thành công!' : 'Thêm khách hàng thành công!');
          location.reload();
        })
        .catch(error => {
          alert('Có lỗi khi lưu khách hàng!');
          console.error(error);
        });
      }

      function deleteCustomer(id) {
        if (confirm('Bạn có chắc chắn muốn xóa khách hàng này?')) {
          fetch(`/api/customers/${id}`, {
            method: 'DELETE'
          })
          .then(response => {
            if (response.ok) {
              alert('Xóa khách hàng thành công!');
              location.reload();
            } else {
              alert('Xóa khách hàng thất bại!');
            }
          })
          .catch(error => {
            alert('Có lỗi khi xóa khách hàng!');
            console.error(error);
          });
        }
      }

      function editCustomer(customer) {
        const form = document.getElementById('addCustomerForm');
        form.style.display = 'block';
        document.getElementById('showAddCustomerFormBtn').style.display = 'none';

        document.getElementById('email').value = customer.email;
        document.getElementById('firstName').value = customer.firstName;
        document.getElementById('lastName').value = customer.lastName;
        document.getElementById('password').value = customer.password || '';
        document.getElementById('phone').value = customer.phone;
        document.getElementById('username').value = customer.username;
        document.getElementById('active').value = customer.active ? "true" : "false";
        document.getElementById('role').value = customer.role;

        // Đổi tên nút (tùy chọn)
        form.querySelector('button[onclick="addCustomer()"]').textContent = "Cập nhật khách hàng";

        // Lưu lại id khách hàng đang sửa
        form.setAttribute('data-edit-id', customer.id);
      }
    </script>
  </body>
</html>
